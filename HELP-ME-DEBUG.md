# å¦‚ä½•å¸®åŠ©æˆ‘ä»¬è¯Šæ–­ CPU å ç”¨é—®é¢˜

ä½ æåˆ°"åœé¡¿ä¹…äº†è¿˜æ˜¯ä¼šå¾ˆå¡ï¼Œnvim CPU 100%"ã€‚ä¸ºäº†å‡†ç¡®è¯Šæ–­é—®é¢˜ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ”¶é›†ä¿¡æ¯ã€‚

## ðŸ” ç¬¬ä¸€æ­¥ï¼šè¿è¡Œè¯Šæ–­è„šæœ¬

```bash
cd ~/nvim-config  # æˆ–ä½ çš„é…ç½®ç›®å½•
./diagnose-cpu.sh
```

è¿™ä¼šç”Ÿæˆä¸€ä¸ª `nvim-diagnostics-XXXXXX.txt` æ–‡ä»¶ï¼Œ**è¯·æŠŠè¿™ä¸ªæ–‡ä»¶çš„å†…å®¹å‘ç»™æˆ‘**ã€‚

## ðŸ“Š ç¬¬äºŒæ­¥ï¼šå®žæ—¶ç›‘æŽ§ï¼ˆå¯é€‰ä½†æŽ¨èï¼‰

åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£è¿è¡Œï¼š

```bash
./monitor-nvim.sh
```

ç„¶åŽï¼š
1. æ‰“å¼€ nvim ç¼–è¾‘ä¸€ä¸ª Python æ–‡ä»¶
2. ç­‰å¾…é—®é¢˜å‡ºçŽ°ï¼ˆä½ è¯´åœé¡¿ä¹…äº†ä¼šå¡ï¼‰
3. å½“ CPU å ç”¨è¿‡é«˜æ—¶ï¼Œç›‘æŽ§è„šæœ¬ä¼šè‡ªåŠ¨è®°å½•è¯¦æƒ…
4. æŒ‰ Ctrl+C åœæ­¢ç›‘æŽ§
5. **å‘é€ç”Ÿæˆçš„ `nvim-monitor-XXXXXX.log` æ–‡ä»¶**

## â“ ç¬¬ä¸‰æ­¥ï¼šå›žç­”ä»¥ä¸‹é—®é¢˜

è¯·å°½å¯èƒ½è¯¦ç»†åœ°å›žç­”ï¼š

### 1. é—®é¢˜å…·ä½“è¡¨çŽ°

- [ ] CPU å ç”¨å¤šå°‘ï¼Ÿï¼ˆ50%? 100%? å¤šä¸ªè¿›ç¨‹åŠ èµ·æ¥ï¼Ÿï¼‰
- [ ] ä»€ä¹ˆæ—¶å€™å¼€å§‹å¡ï¼Ÿ
  - [ ] æ‰“å¼€æ–‡ä»¶æ—¶å°±å¡
  - [ ] ç¼–è¾‘ä¸€æ®µæ—¶é—´åŽæ‰å¡
  - [ ] åœæ­¢ç¼–è¾‘ï¼ˆä¸åŠ¨ï¼‰ä¸€æ®µæ—¶é—´åŽå¡
  - [ ] ç‰¹å®šæ“ä½œåŽå¡ï¼ˆæ¯”å¦‚ä¿å­˜ã€è¡¥å…¨ç­‰ï¼‰
- [ ] å¡ä½åŽä¼šè‡ªåŠ¨æ¢å¤å—ï¼Ÿè¿˜æ˜¯ä¸€ç›´å¡ï¼Ÿ
- [ ] å¤šé•¿æ—¶é—´åŽä¼šå‡ºçŽ°é—®é¢˜ï¼Ÿï¼ˆå‡ åˆ†é’Ÿï¼Ÿå‡ ç§’ï¼Ÿï¼‰

### 2. æ–‡ä»¶ä¿¡æ¯

- [ ] ç¼–è¾‘çš„æ˜¯ä»€ä¹ˆæ–‡ä»¶ï¼Ÿï¼ˆPython? JavaScript? å…¶ä»–ï¼Ÿï¼‰
- [ ] æ–‡ä»¶å¤§å°ï¼Ÿï¼ˆç”¨ `ls -lh æ–‡ä»¶å` æŸ¥çœ‹ï¼‰
- [ ] æ–‡ä»¶è¡Œæ•°ï¼Ÿï¼ˆç”¨ `wc -l æ–‡ä»¶å` æŸ¥çœ‹ï¼‰
- [ ] æ˜¯å¦åœ¨ä¸€ä¸ªå¤§çš„é¡¹ç›®/å·¥ä½œåŒºä¸­ï¼Ÿï¼ˆé¡¹ç›®æœ‰å¤šå°‘æ–‡ä»¶ï¼Ÿï¼‰

### 3. æ“ä½œçŽ¯å¢ƒ

- [ ] ä½ çš„æ“ä½œç³»ç»Ÿï¼Ÿï¼ˆmacOS? Linux? WSL?ï¼‰
- [ ] Neovim ç‰ˆæœ¬ï¼Ÿï¼ˆè¿è¡Œ `nvim --version`ï¼‰
- [ ] æ˜¯å¦ä½¿ç”¨äº† LSPï¼Ÿï¼ˆç¼–è¾‘ Python æ–‡ä»¶æ—¶æœ‰ä»£ç è¡¥å…¨/é”™è¯¯æç¤ºå—ï¼Ÿï¼‰
- [ ] æ˜¯å¦å¯ç”¨äº† Codeium AI è¡¥å…¨ï¼Ÿï¼ˆæœ‰çœ‹åˆ° AI å»ºè®®å—ï¼Ÿï¼‰

### 4. è¿›ç¨‹ä¿¡æ¯ï¼ˆé‡è¦ï¼ï¼‰

å½“é—®é¢˜å‡ºçŽ°æ—¶ï¼Œåœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰ nvim è¿›ç¨‹
ps aux | grep nvim

# æŸ¥çœ‹ Python ç›¸å…³è¿›ç¨‹
ps aux | grep python

# æŸ¥çœ‹è¿›ç¨‹æ ‘
pstree -p | grep nvim
```

**è¯·æŠŠè¾“å‡ºç»“æžœå‘ç»™æˆ‘ï¼**

## ðŸŽ¯ æˆ‘å·²ç»å‘çŽ°çš„å¯èƒ½é—®é¢˜ç‚¹

åŸºäºŽä½ çš„é…ç½®ï¼Œæˆ‘å‘çŽ°äº†å‡ ä¸ªå¯èƒ½å¯¼è‡´ CPU å ç”¨çš„åœ°æ–¹ï¼š

### 1. âš ï¸ Pyright LSP (Python è¯­è¨€æœåŠ¡å™¨)

**ä½ç½®**: `lua/plugins/lsp.lua:74-82`

å½“å‰é…ç½®ï¼š
```lua
python = {
  analysis = {
    diagnosticMode = 'workspace',  -- âš ï¸ è¿™ä¼šåˆ†æžæ•´ä¸ªå·¥ä½œåŒºï¼
    typeCheckingMode = 'basic',
  },
}
```

**é—®é¢˜**: å¦‚æžœä½ çš„é¡¹ç›®å¾ˆå¤§ï¼ŒPyright ä¼šæŒç»­åˆ†æžæ‰€æœ‰ Python æ–‡ä»¶ï¼Œå¯¼è‡´é«˜ CPU å ç”¨ã€‚

**å¿«é€Ÿæµ‹è¯•**: ä¸´æ—¶ç¦ç”¨ Pyrightï¼Œçœ‹é—®é¢˜æ˜¯å¦æ¶ˆå¤±ï¼š
```vim
:LspStop pyright
```

### 2. âš ï¸ Codeium AI è¡¥å…¨

**ä½ç½®**: `lua/plugins/ai.lua`

**é—®é¢˜**: AI è¡¥å…¨æ’ä»¶ä¼šåœ¨åŽå°æŒç»­è¿è¡Œï¼Œå¯èƒ½æ¶ˆè€— CPUã€‚

**å¿«é€Ÿæµ‹è¯•**: ä¸´æ—¶ç¦ç”¨ Codeiumï¼š
```vim
:Codeium Disable
```

### 3. âš ï¸ Treesitter è‡ªåŠ¨å®‰è£…

**ä½ç½®**: `lua/plugins/treesitter.lua:20`

```lua
auto_install = true,  -- âš ï¸ å¯èƒ½åœ¨åŽå°è‡ªåŠ¨å®‰è£…è§£æžå™¨
```

**é—®é¢˜**: ç¬¬ä¸€æ¬¡æ‰“å¼€æŸç§ç±»åž‹çš„æ–‡ä»¶æ—¶ï¼Œä¼šè‡ªåŠ¨ä¸‹è½½å’Œç¼–è¯‘ Treesitter è§£æžå™¨ã€‚

### 4. âš ï¸ Treesitter é«˜äº®å’Œå¢žé‡é€‰æ‹©

å¯¹äºŽå¤§æ–‡ä»¶ï¼ŒTreesitter çš„è¯­æ³•é«˜äº®å¯èƒ½å¾ˆæ¶ˆè€—æ€§èƒ½ã€‚

**å¿«é€Ÿæµ‹è¯•**: ä¸´æ—¶ç¦ç”¨ Treesitter é«˜äº®ï¼š
```vim
:TSBufDisable highlight
```

## ðŸ”§ ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼ˆæµ‹è¯•ç”¨ï¼‰

åˆ›å»ºä¸€ä¸ªæœ€å°åŒ–é…ç½®æ¥æµ‹è¯•ï¼š

```bash
# å¤‡ä»½å½“å‰é…ç½®
mv ~/.config/nvim ~/.config/nvim.backup

# åˆ›å»ºæœ€å°é…ç½®
mkdir -p ~/.config/nvim
cat > ~/.config/nvim/init.lua << 'EOF'
-- æœ€å°åŒ–é…ç½®ï¼Œä»…åŸºç¡€åŠŸèƒ½
vim.opt.number = true
vim.opt.expandtab = true
vim.opt.tabstop = 4
vim.opt.shiftwidth = 4

-- ç¦ç”¨æ‰€æœ‰ providers
vim.g.loaded_python_provider = 0
vim.g.loaded_python3_provider = 0
vim.g.loaded_ruby_provider = 0
vim.g.loaded_perl_provider = 0
vim.g.loaded_node_provider = 0

-- æ€§èƒ½ä¼˜åŒ–
vim.opt.updatetime = 2000
vim.opt.lazyredraw = true
vim.opt.synmaxcol = 200
EOF

# æµ‹è¯•
nvim test.py
```

å¦‚æžœæœ€å°é…ç½®æ²¡æœ‰é—®é¢˜ï¼Œè¯´æ˜Žæ˜¯æŸä¸ªæ’ä»¶å¯¼è‡´çš„ã€‚

æµ‹è¯•å®ŒæˆåŽæ¢å¤é…ç½®ï¼š
```bash
rm -rf ~/.config/nvim
mv ~/.config/nvim.backup ~/.config/nvim
```

## ðŸ“ è¯·æä¾›çš„å®Œæ•´ä¿¡æ¯æ¸…å•

è¯·æ”¶é›†å¹¶å‘é€ä»¥ä¸‹ä¿¡æ¯ï¼š

- [ ] `diagnose-cpu.sh` ç”Ÿæˆçš„è¯Šæ–­æ–‡ä»¶
- [ ] `monitor-nvim.sh` ç”Ÿæˆçš„ç›‘æŽ§æ—¥å¿—ï¼ˆå¦‚æžœè¿è¡Œäº†ï¼‰
- [ ] é—®é¢˜å‡ºçŽ°æ—¶çš„ `ps aux | grep nvim` è¾“å‡º
- [ ] å›žç­”ä¸Šé¢çš„æ‰€æœ‰é—®é¢˜
- [ ] æµ‹è¯•ä¸´æ—¶è§£å†³æ–¹æ¡ˆçš„ç»“æžœï¼ˆLSP/Codeium/Treesitter ç¦ç”¨æµ‹è¯•ï¼‰

## ðŸš€ ç«‹å³å¯ä»¥å°è¯•çš„ä¼˜åŒ–

åœ¨ç­‰å¾…å®Œæ•´è¯Šæ–­çš„åŒæ—¶ï¼Œä½ å¯ä»¥å…ˆå°è¯•è¿™äº›ä¼˜åŒ–ï¼š

### æ–¹æ¡ˆ 1: ä¼˜åŒ– Pyrightï¼ˆPython LSPï¼‰

ç¼–è¾‘ `lua/plugins/lsp.lua`ï¼Œæ‰¾åˆ° pyright é…ç½®ï¼Œä¿®æ”¹ä¸ºï¼š

```lua
elseif server == 'pyright' then
  opts.settings = {
    python = {
      analysis = {
        autoSearchPaths = true,
        useLibraryCodeForTypes = true,
        diagnosticMode = 'openFilesOnly',  -- æ”¹ä¸ºåªåˆ†æžæ‰“å¼€çš„æ–‡ä»¶ï¼
        typeCheckingMode = 'off',          -- æˆ–å…³é—­ç±»åž‹æ£€æŸ¥
      },
    },
  }
```

### æ–¹æ¡ˆ 2: ç¦ç”¨ Treesitter è‡ªåŠ¨å®‰è£…

ç¼–è¾‘ `lua/plugins/treesitter.lua`ï¼š

```lua
auto_install = false,  -- æ”¹ä¸º false
```

### æ–¹æ¡ˆ 3: å®Œå…¨ç¦ç”¨ AI è¡¥å…¨ï¼ˆä¸´æ—¶ï¼‰

ç¼–è¾‘ `lua/plugins/init.lua`ï¼Œæ³¨é‡ŠæŽ‰ Codeium æ’ä»¶ï¼š

```lua
-- { 'Exafunction/codeium.vim', event = 'BufEnter' },
```

### æ–¹æ¡ˆ 4: æ·»åŠ æ›´æ¿€è¿›çš„æ€§èƒ½ä¼˜åŒ–

ç¼–è¾‘ `lua/core/perf.lua`ï¼Œåœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼š

```lua
-- ç¦ç”¨ä¸€äº›å¯èƒ½æ¶ˆè€—æ€§èƒ½çš„åŠŸèƒ½
vim.opt.backup = false
vim.opt.writebackup = false
vim.opt.swapfile = false
vim.opt.undofile = false  -- ä¸´æ—¶ç¦ç”¨

-- LSP æ€§èƒ½ä¼˜åŒ–
vim.lsp.set_log_level("ERROR")  -- å‡å°‘æ—¥å¿—

-- é™åˆ¶è¯Šæ–­æ›´æ–°é¢‘çŽ‡
vim.diagnostic.config({
  update_in_insert = false,
  virtual_text = false,  -- ç¦ç”¨è™šæ‹Ÿæ–‡æœ¬
})
```

## ðŸ“ž èŽ·å–å¸®åŠ©

æä¾›ä¸Šè¿°ä¿¡æ¯åŽï¼Œæˆ‘å¯ä»¥ï¼š

1. ç²¾ç¡®å®šä½æ˜¯å“ªä¸ªç»„ä»¶å¯¼è‡´çš„é—®é¢˜ï¼ˆLSP? Treesitter? AI? Provider?ï¼‰
2. æä¾›é’ˆå¯¹æ€§çš„ä¿®å¤æ–¹æ¡ˆ
3. ä¼˜åŒ–ä½ çš„å…·ä½“ä½¿ç”¨åœºæ™¯
4. å¦‚æžœæ˜¯ bugï¼Œå¯ä»¥å‘ä¸Šæ¸¸é¡¹ç›®æŠ¥å‘Š

æ²¡æœ‰è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯ï¼Œæˆ‘åªèƒ½çŒœæµ‹ï¼Œå¯èƒ½æ— æ³•çœŸæ­£è§£å†³é—®é¢˜ã€‚è¯·åŠ¡å¿…æä¾›è¯Šæ–­è¾“å‡ºï¼
